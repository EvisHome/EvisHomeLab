<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for EvisHomeLab - A comprehensive Smart Home &amp; Home Lab built with Home Assistant, Unraid, and Networking gear.">
      
      
        <meta name="author" content="Evis">
      
      
        <link rel="canonical" href="https://www.evishome.com/smart-home/packages/smart_notifications/">
      
      
        <link rel="prev" href="../shelly_3em/">
      
      
        <link rel="next" href="../smart_speakers/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Package: Smart Notifications - EvisHomeLab</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Q3C6JS2Q46"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Q3C6JS2Q46",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Q3C6JS2Q46",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
  <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#package-smart-notifications" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EvisHomeLab" class="md-header__button md-logo" aria-label="EvisHomeLab" data-md-component="logo">
      
  <img src="../../../assets/images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EvisHomeLab
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Package: Smart Notifications
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="orange" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="orange" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/EvisHome/EvisHomeLab" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    EvisHome/EvisHomeLab
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EvisHomeLab" class="md-nav__button md-logo" aria-label="EvisHomeLab" data-md-component="logo">
      
  <img src="../../../assets/images/favicon.png" alt="logo">

    </a>
    EvisHomeLab
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/EvisHome/EvisHomeLab" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    EvisHome/EvisHomeLab
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Device Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../articles/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Articles
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Articles
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/ai-log-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Log Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/area-occupancy-sensor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Area Occupancy Sensor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/bed-occupancy-sensor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bed Occupancy Sensor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/dns-adguard-unbound/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DNS AdGuard Home &amp; Unbound
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/motorized-blinds/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Motorized Horizontal Blinds - Tilt Action
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/philips-hue-motion-sensor-mount/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Philips Hue Motion Sensor Wall Mount
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/self-healing-tailscale-nodes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Self-Healing Tailscale Nodes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/tinkercad-project-box-creator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TinkerCad Project Box Creator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/virtual-fireplace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual Fireplace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_11">
        
          
          <label class="md-nav__link" for="__nav_3_11" id="__nav_3_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ai log summary
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ai log summary
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/ai-log-summary/home-lab-logs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home lab logs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/ai-log-summary/unraid-syslog-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unraid syslog server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../home-lab/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Home lab
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Home lab
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Planning
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Planning
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../planning/ai_roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Automation Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Smart home
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Smart home
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI Automations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration &amp; Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../addons/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Addons
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Addons
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../addons/frigate_nvr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Frigate NVR
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../dashboards/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Dashboards
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dashboards
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_2">
        
          
          <label class="md-nav__link" for="__nav_6_5_2" id="__nav_6_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Admin system
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Admin system
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/admin-system/system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_3">
        
          
          <label class="md-nav__link" for="__nav_6_5_3" id="__nav_6_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Area automations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Area automations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/area-automations/room_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Room Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_4">
        
          
          <label class="md-nav__link" for="__nav_6_5_4" id="__nav_6_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Area manager
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Area manager
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/area-manager/room_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Room Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_5">
        
          
          <label class="md-nav__link" for="__nav_6_5_5" id="__nav_6_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dashboard persons
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dashboard persons
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/dashboard-persons/car/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CAR
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/dashboard-persons/evis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/dashboard-persons/guest_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guest-1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_6">
        
          
          <label class="md-nav__link" for="__nav_6_5_6" id="__nav_6_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Home access
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Home access
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/home-access/home_access_center/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home Access Center
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_7">
        
          
          <label class="md-nav__link" for="__nav_6_5_7" id="__nav_6_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Main
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Main
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/backyard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Backyard
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/bathroom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bathroom
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/bedroom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bedroom
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/daughter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Daughter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/electricity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Electricity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/electricity_dev/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Electricity Dev
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/front_door/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Front Door
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/guest_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guest-2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/guest_3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guest-3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/hallway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hallway
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/home/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/kitchen/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kitchen
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/living_room/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Living Room
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/lobby/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lobby
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/mud_room/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mud Room
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/office/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Office
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/sauna/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sauna
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Settings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/stairs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stairs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/main/toilet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Toilet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_8">
        
          
          <label class="md-nav__link" for="__nav_6_5_8" id="__nav_6_5_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Notification center
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Notification center
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/notification-center/notification_builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Notification Builder
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/notification-center/notifications_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Notifications Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_9">
        
          
          <label class="md-nav__link" for="__nav_6_5_9" id="__nav_6_5_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Room management
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Room management
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/room-management/room_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Room Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_10">
        
          
          <label class="md-nav__link" for="__nav_6_5_10" id="__nav_6_5_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Smart speakers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Smart speakers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dashboards/smart-speakers/smart_speakers_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Smart Speakers Manager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_6">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../integrations/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Integrations
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_6" id="__nav_6_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integrations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/ai_reporter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integration: AI Log Reporter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_7" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Packages
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_7" id="__nav_6_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Packages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Ai Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../airthings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Airthings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aqara_w500/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Aqara W500
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../area_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Area Manager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../car/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Car
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debug_script/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Debug Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dishwasher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Dishwasher
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dna_tv_hub/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Dna Tv Hub
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fireplace_automation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Fireplace Automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../garmin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Garmin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../home_time_modes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Home Time Modes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nordpool_prices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Nordpool Prices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../office_pc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Office Pc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../philips_air_purifier/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Philips Air Purifier
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../room_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Room Manager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Scenes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shelly_3em/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Shelly 3Em
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Package: Smart Notifications
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Smart Notifications
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#executive-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Executive Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process-description-non-technical" class="md-nav__link">
    <span class="md-ellipsis">
      
        Process Description (Non-Technical)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dashboard-connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dashboard Connections
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Diagram
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-source-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration (Source Code)
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../smart_speakers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Smart Speakers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tailscale_edge_monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Tailscale Edge Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tailscale_halo_monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Tailscale Halo Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tailscale_monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Tailscale Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unifi_access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Unifi Access
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../washing_machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package: Washing Machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../workflow/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Workflow
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workflow
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../workflow/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation System Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../workflow/setup_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../workflow/tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tools Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tags
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#executive-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Executive Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process-description-non-technical" class="md-nav__link">
    <span class="md-ellipsis">
      
        Process Description (Non-Technical)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dashboard-connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dashboard Connections
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Diagram
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-source-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration (Source Code)
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  

  <nav class="md-tags">
    
      
      
      
      
        <a href="../../../tags/#tag:automated" class="md-tag">automated</a>
      
    
      
      
      
      
        <a href="../../../tags/#tag:package" class="md-tag">package</a>
      
    
  </nav>


  
  


<h1 id="package-smart-notifications">Package: Smart Notifications</h1>
<p><strong>Version:</strong> 1.0.0<br>
<strong>Description:</strong> Helpers and logic for the dynamic notification router</p>
<!-- START_IMAGE -->
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../assets/smart_notifications.png" data-desc-position="bottom"><img alt="Package Diagram" src="../assets/smart_notifications.png"></a></p>
<!-- END_IMAGE -->

<h2 id="executive-summary">Executive Summary</h2>
<!-- START_SUMMARY -->
<p>The <strong>Smart Notifications</strong> package is a dynamic, user-centric routing engine for Home Assistant. Unlike static notification groups, this system allows users to manage their own subscriptions to different notification categories (e.g., Security, System, Info) directly from the dashboard. It abstracts the complexity of device management, automatically handling device services (Android/iOS) and presence detection, ensuring alerts are delivered only when relevant and desired.</p>
<!-- END_SUMMARY -->

<h2 id="process-description-non-technical">Process Description (Non-Technical)</h2>
<!-- START_DETAILED -->
<p>The system operates on a "Publish-Subscribe" model adapted for a smart home:</p>
<ol>
<li><strong>User Onboarding</strong>: An administrator selects a Home Assistant <code>person</code> entity and "initializes" them. The system automatically generates a suite of configuration "helpers" (switches) for every notification category defined in the system.</li>
<li><strong>Preference Management</strong>: Users interact with a dashboard calling these switches. If a user wants to mute "Security" alerts but keep "Energy" alerts, they simply toggle the respective switches.</li>
<li><strong>Smart Routing</strong>: When an automation needs to send a notification, it calls the <code>notify_smart_master</code> script with a <code>category</code> (e.g., <code>security</code>) and the message.</li>
<li><strong>Delivery Logic</strong>: The router iterates through all registered users. For each user, it checks:<ul>
<li><strong>Subscription</strong>: Is the switch for this category ON?</li>
<li><strong>Presence</strong>: If the alert is "local only" or the user is away (and presence checks are enabled), the message is suppressed.</li>
<li><strong>Platform</strong>: It formats the message specifically for the user's defined device type (iOS vs Android), handling critical alerts and actionable notifications appropriate to the platform.</li>
</ul>
</li>
</ol>
<!-- END_DETAILED -->

<h2 id="dashboard-connections">Dashboard Connections</h2>
<!-- START_DASHBOARD -->
<p>This package powers the following dashboard views:</p>
<ul>
<li><strong><a href="../../dashboards/admin-system/system/">System</a></strong>: <em>This view provides deep insights into the Proxmox 'Halo' virtualization node. It features real-time resource monitoring (CPU, RAM) using <code>mini-graph-card</code>, and critical power controls (Reboot, Shutdown) protected by confirmation dialogs. It also offers bulk management for guest VMs/containers and tracks system update status, ensuring the infrastructure host is healthy and up-to-date.</em> (Uses 1 entities)</li>
<li><strong><a href="../../dashboards/area-automations/room_management/">Room Management</a></strong> (Uses 2 entities)</li>
<li><strong><a href="../../dashboards/area-manager/room_management/">Room Management</a></strong> (Uses 2 entities)</li>
<li><strong><a href="../../dashboards/main/living_room/">Living Room</a></strong>: <em>The Living Room dashboard is a media and comfort hub. It features in-depth environmental monitoring (Radon, VOCs, CO2) via Airthings Wave, displaying historical trends. Entertainment controls are central, with remotes for the TV and Soundbar, plus power management for the media wall. The view also includes specific controls for the fireplace, air purifier modes, and various lighting scenes, alongside standard occupancy settings.</em> (Uses 1 entities)</li>
<li><strong><a href="../../dashboards/notification-center/notifications_management/">Notifications Management</a></strong>: <em>The Notification Center dashboard provides a comprehensive interface for managing the smart home's notification system. Administrators can add or remove users for mobile app notifications and define notification categories (e.g., 'Garage', 'Electricity'). The view allows for granular control over subscriptions, enabling individual users to opt-in or out of specific notification types, and includes tools to map and monitor notification-related automations.</em> (Uses 9 entities)</li>
<li><strong><a href="../../dashboards/room-management/room_management/">Room Management</a></strong>: <em>The Room Management dashboard serves as the administrative backend for the home's room logic. It allows users to initialize new rooms (creating necessary helper entities) or delete existing ones. It features a dynamic "Configured Rooms" section powered by <code>auto-entities</code>, which automatically lists all configured rooms and provides collapsible controls for their automation modes, occupancy sensors, and timeouts.</em> (Uses 3 entities)</li>
<li><strong><a href="../../dashboards/smart-speakers/smart_speakers_manager/">Smart Speakers Manager</a></strong> (Uses 2 entities)</li>
</ul>
<!-- END_DASHBOARD -->

<h2 id="architecture-diagram">Architecture Diagram</h2>
<!-- START_MERMAID_DESC -->
<p>When a notification request triggers the <code>notify_smart_master</code> router, the system begins a parallel evaluation for every registered user. It retrieves the user's specific settingschecking if they have subscribed to the message's <code>category</code>, verifying if a 'Presence Check' is required, and determining their current device platform (iOS or Android). Only if the subscription is active and the presence criteria are met does the router format the payload (adjusting for platform-specifics like critical volume or click actions) and dispatch it to the specific mobile app service.</p>
<!-- END_MERMAID_DESC -->

<!-- START_MERMAID -->
<pre class="mermaid"><code>sequenceDiagram
    participant Auto as Automation
    participant Router as Script: Smart Master
    participant Config as User Switches
    participant Logic as Logic Filter
    participant App as Mobile App

    Auto-&gt;&gt;Router: Call (Title, Msg, Category="security")
    loop For Each User
        Router-&gt;&gt;Config: Check State: switch.user_security_notification
        Config--&gt;&gt;Router: State "ON"

        Router-&gt;&gt;Logic: Check Presence Requirement
        alt User is Home OR Presence User Not Required
            Logic--&gt;&gt;Router: Allowed
            Router-&gt;&gt;Router: Format Data (Android/iOS)
            Router-&gt;&gt;App: Send Notification
        else User Away AND Required
            Logic--&gt;&gt;Router: Blocked
        end
    end</code></pre>
<!-- END_MERMAID -->

<h2 id="configuration-source-code">Configuration (Source Code)</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Package: Smart Notification System</span>
<span class="c1"># Version: 1.0.0</span>
<span class="c1"># Description: Helpers and logic for the dynamic notification router</span>
<span class="c1"># Dependencies: notify.*, input_select.notify_mgmt_service, script.notify_smart_master</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># 1. HELPERS (Input Text, Select)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="nt">input_text</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># RETAINED: Only retained helpers for categories and deletion IDs</span>
<span class="w">  </span><span class="c1">## MASTER LIST FOR THE CATEGORIES</span>
<span class="w">  </span><span class="nt">notify_mgmt_categories</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Categories</span><span class="nv"> </span><span class="s">(comma-separated)"</span>
<span class="w">    </span><span class="nt">initial</span><span class="p">:</span><span class="w"> </span><span class="s">"info,system,security,alarm,doorbell"</span>

<span class="w">  </span><span class="c1"># TO BE REMOVED</span>
<span class="w">  </span><span class="nt">notify_delete_category</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Category</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Delete"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:archive-remove</span>

<span class="w">  </span><span class="nt">notify_add_category</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"New</span><span class="nv"> </span><span class="s">Category</span><span class="nv"> </span><span class="s">Name"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:playlist-plus</span>

<span class="nt">input_select</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Dropdown for selecting a category to delete</span>
<span class="w">  </span><span class="nt">notify_delete_category</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Category</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Delete"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:archive-remove</span>
<span class="w">    </span><span class="nt">options</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-select-"</span>

<span class="w">  </span><span class="c1"># Dropdown populated with existing Home Assistant Persons</span>
<span class="w">  </span><span class="nt">notify_mgmt_person_select</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Select</span><span class="nv"> </span><span class="s">Person</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Initialize"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:account-circle</span>
<span class="w">    </span><span class="nt">options</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-select-"</span><span class="w"> </span><span class="c1"># Placeholder before population</span>

<span class="w">  </span><span class="c1"># List of the Notify services for devices</span>
<span class="w">  </span><span class="nt">notify_mgmt_service</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Notify</span><span class="nv"> </span><span class="s">Service"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:cellphone-message</span>
<span class="w">    </span><span class="nt">options</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-select-"</span>

<span class="w">  </span><span class="c1"># Dropdown for mobile platform</span>
<span class="w">  </span><span class="nt">notify_mgmt_platform</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Platform"</span>
<span class="w">    </span><span class="nt">options</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">android</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ios</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:apple-ios</span>

<span class="w">  </span><span class="c1"># Dropdown for deleting users</span>
<span class="w">  </span><span class="nt">notify_mgmt_delete_user_select</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Select</span><span class="nv"> </span><span class="s">User</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Delete"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:account-remove</span>
<span class="w">    </span><span class="nt">options</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-select-"</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># 2. INPUT BOOLEANS (Flags &amp; Maintenance)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="nt">input_boolean</span><span class="p">:</span>

<span class="w">  </span><span class="c1"># Global Category Settings (Generated dynamically, but good to have base logic ready)</span>
<span class="w">  </span><span class="c1"># Note: Individual category switches are MQTT switches now, not input_booleans.</span>

<span class="w">  </span><span class="c1"># Removed: notify_flag_person_list_refresh (Not used, we trigger automation directly)</span>

<span class="c1"># ... (Rest of the file remains the same)</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># 3. SCRIPTS &amp; AUTOMATIONS (Logic)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># --- CREATE USER (Pulls Name and ID from Person Entity) ---</span>
<span class="w">  </span><span class="nt">create_notify_user</span><span class="p">:</span>
<span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">Create</span><span class="nv"> </span><span class="s">Notification</span><span class="nv"> </span><span class="s">User"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:account-plus</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">single</span>
<span class="w">    </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># Get selected person name (e.g., "Evis")</span>
<span class="w">          </span><span class="nt">user_name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_select.notify_mgmt_person_select')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="c1"># CRITICAL: Create slug (e.g., "Evis" -&gt; "Evis")</span>
<span class="w">          </span><span class="nt">user_slug</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">user_name</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">slugify</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="c1"># Ensure we link back to the native HA person entity</span>
<span class="w">          </span><span class="nt">person_entity</span><span class="p">:</span><span class="w"> </span><span class="s">"person.{{</span><span class="nv"> </span><span class="s">user_name</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">slugify</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">          </span><span class="nt">notify_service</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_select.notify_mgmt_service')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_select.notify_mgmt_platform')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">categories</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_text.notify_mgmt_categories')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">categories.split(',')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">map('trim')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># A. Create User Switch</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}/config"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{</span>
<span class="w">                    </span><span class="no">"name": "{{ repeat.item|capitalize }} Notification",</span>
<span class="w">                    </span><span class="no">"default_entity_id": "switch.{{ repeat.item }}_notification_{{ user_slug }}",</span>
<span class="w">                    </span><span class="no">"unique_id": "notify_switch_{{ user_slug }}_{{ repeat.item }}",</span>
<span class="w">                    </span><span class="no">"icon": "mdi:bell-ring",</span>
<span class="w">                    </span><span class="no">"command_topic": "notify/{{ user_slug }}/{{ repeat.item }}/set",</span>
<span class="w">                    </span><span class="no">"state_topic": "notify/{{ user_slug }}/{{ repeat.item }}/state",</span>
<span class="w">                    </span><span class="no">"availability_topic": "notify/{{ user_slug }}/availability",</span>
<span class="w">                    </span><span class="no">"payload_available": "online",</span>
<span class="w">                    </span><span class="no">"json_attributes_topic": "notify/{{ user_slug }}/attributes",</span>
<span class="w">                    </span><span class="no">"device": {</span>
<span class="w">                      </span><span class="no">"identifiers": ["notify_user_{{ user_slug }}"],</span>
<span class="w">                      </span><span class="no">"name": "{{ user_name }} |",</span>
<span class="w">                      </span><span class="no">"manufacturer": "Home Assistant",</span>
<span class="w">                      </span><span class="no">"model": "Notification Profile"</span>
<span class="w">                    </span><span class="no">}</span>
<span class="w">                  </span><span class="no">}</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}/attributes"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{ "user_slug": "{{ user_slug }}", "linked_person": "{{ person_entity }}" }</span>

<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">                  </span><span class="nt">value_template</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                    </span><span class="no">{{ states('switch.' ~ repeat.item ~ '_notification_' ~ user_slug) in ['unknown', 'unavailable', 'none'] }}</span>
<span class="w">              </span><span class="nt">then</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">                  </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                    </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}/state"</span>
<span class="w">                    </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"ON"</span>

<span class="w">            </span><span class="c1"># B. Create GLOBAL CATEGORY SETTING Switch (Unchanged)</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_category_{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}_local/config"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{</span>
<span class="w">                    </span><span class="no">"name": "Notify {{ repeat.item|capitalize }}: When Home",</span>
<span class="w">                    </span><span class="no">"name": "Notify {{ repeat.item|capitalize }}: When Home",</span>
<span class="w">                    </span><span class="no">"unique_id": "notify_category_{{ repeat.item }}_local",</span>
<span class="w">                    </span><span class="no">"icon": "mdi:home-account",</span>
<span class="w">                    </span><span class="no">"command_topic": "notify/settings/{{ repeat.item }}/local_only/set",</span>
<span class="w">                    </span><span class="no">"state_topic": "notify/settings/{{ repeat.item }}/local_only/state",</span>
<span class="w">                    </span><span class="no">"device": {</span>
<span class="w">                      </span><span class="no">"identifiers": ["notify_system_settings"],</span>
<span class="w">                      </span><span class="no">"name": "Cat |",</span>
<span class="w">                      </span><span class="no">"manufacturer": "Home Assistant",</span>
<span class="w">                      </span><span class="no">"model": "Global Rules"</span>
<span class="w">                    </span><span class="no">}</span>
<span class="w">                  </span><span class="no">}</span>

<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">                  </span><span class="nt">value_template</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                    </span><span class="no">{{ states('switch.notify_category_' ~ repeat.item ~ '_local') in ['unknown', 'unavailable', 'none'] }}</span>
<span class="w">              </span><span class="nt">then</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">                  </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                    </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/settings/{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}/local_only/state"</span>
<span class="w">                    </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"OFF"</span>

<span class="w">      </span><span class="c1"># C. Create Helpers</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/text/notify_{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}_service/config"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">              </span><span class="no">"name": "{{ user_name }} Notify Service",</span>
<span class="w">              </span><span class="no">"name": "{{ user_name }} Notify Service",</span>
<span class="w">              </span><span class="no">"unique_id": "notify_service_{{ user_slug }}",</span>
<span class="w">              </span><span class="no">"icon": "mdi:cellphone",</span>
<span class="w">              </span><span class="no">"command_topic": "notify/{{ user_slug }}/service/set",</span>
<span class="w">              </span><span class="no">"state_topic": "notify/{{ user_slug }}/service/state",</span>
<span class="w">              </span><span class="no">"availability_topic": "notify/{{ user_slug }}/availability",</span>
<span class="w">              </span><span class="no">"device": { "identifiers": ["notify_user_{{ user_slug }}"] }</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}/service/state"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">notify_service</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/select/notify_{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}_platform/config"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">              </span><span class="no">"name": "{{ user_name }} Phone Platform",</span>
<span class="w">              </span><span class="no">"name": "{{ user_name }} Phone Platform",</span>
<span class="w">              </span><span class="no">"unique_id": "notify_platform_{{ user_slug }}",</span>
<span class="w">              </span><span class="no">"icon": "mdi:apple-ios",</span>
<span class="w">              </span><span class="no">"options": ["android", "ios"],</span>
<span class="w">              </span><span class="no">"command_topic": "notify/{{ user_slug }}/platform/set",</span>
<span class="w">              </span><span class="no">"state_topic": "notify/{{ user_slug }}/platform/state",</span>
<span class="w">              </span><span class="no">"availability_topic": "notify/{{ user_slug }}/availability",</span>
<span class="w">              </span><span class="no">"device": { "identifiers": ["notify_user_{{ user_slug }}"] }</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}/platform/state"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">platform</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}/availability"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"online"</span>

<span class="w">      </span><span class="c1"># Refresh Lists</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="s">"00:00:02"</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.trigger</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.system_populate_notify_services</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">skip_condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="c1"># Reset Dropdowns</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.select_option</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_mgmt_person_select</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_mgmt_service</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">option</span><span class="p">:</span><span class="w"> </span><span class="s">"-select-"</span>

<span class="w">  </span><span class="c1"># --- DELETE USER (Updated to use Dropdown) ---</span>
<span class="w">  </span><span class="nt">delete_notify_user</span><span class="p">:</span>
<span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">Delete</span><span class="nv"> </span><span class="s">Notification</span><span class="nv"> </span><span class="s">User"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:account-remove</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">single</span>
<span class="w">    </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># Get slug from dropdown</span>
<span class="w">          </span><span class="nt">user_slug</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_select.notify_mgmt_delete_user_select')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">categories</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_text.notify_mgmt_categories')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">categories.split(',')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">map('trim')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}/config"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>

<span class="w">      </span><span class="c1"># Delete Helpers</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/text/notify_{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}_service/config"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/select/notify_{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}_platform/config"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>

<span class="w">      </span><span class="c1"># Set Offline</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}/availability"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"offline"</span>

<span class="w">      </span><span class="c1"># Refresh Lists</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="s">"00:00:02"</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.trigger</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.system_populate_notify_services</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">skip_condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="c1"># Reset Dropdown</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.select_option</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_mgmt_delete_user_select</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">option</span><span class="p">:</span><span class="w"> </span><span class="s">"-select-"</span>

<span class="w">  </span><span class="c1"># --- DELETE CATEGORY ---</span>
<span class="w">  </span><span class="nt">delete_notify_category_global</span><span class="p">:</span>
<span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">Delete</span><span class="nv"> </span><span class="s">Notification</span><span class="nv"> </span><span class="s">Category"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:archive-remove</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">single</span>
<span class="w">    </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># NOW USES THE INPUT SELECT</span>
<span class="w">          </span><span class="nt">category</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_select.notify_delete_category')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">trim</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">lower</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">current_list</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_text.notify_mgmt_categories')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="c1"># Prevent deleting if 'select' is chosen or empty</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">        </span><span class="nt">value_template</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">category</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">['-select-',</span><span class="nv"> </span><span class="s">'select',</span><span class="nv"> </span><span class="s">'unknown',</span><span class="nv"> </span><span class="s">'unavailable',</span><span class="nv"> </span><span class="s">'']</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="c1"># Remove from Master List (Text Input)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_text.set_value</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_text.notify_mgmt_categories</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ current_list.split(',') </span>
<span class="w">               </span><span class="no">| map('trim') </span>
<span class="w">               </span><span class="no">| reject('eq', category) </span>
<span class="w">               </span><span class="no">| join(',') }}</span>

<span class="w">      </span><span class="c1"># Remove Global Switch Config</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_category_{{</span><span class="nv"> </span><span class="s">category</span><span class="nv"> </span><span class="s">}}_local/config"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>

<span class="w">      </span><span class="c1"># Remove User Switches for this category</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.switch </span>
<span class="w">               </span><span class="no">| selectattr('entity_id', 'search', '^switch\.' ~ category ~ '_notification_')</span>
<span class="w">               </span><span class="no">| map(attribute='attributes.user_slug') </span>
<span class="w">               </span><span class="no">| reject('undefined')</span>
<span class="w">               </span><span class="no">| unique </span>
<span class="w">               </span><span class="no">| list }}</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">category</span><span class="nv"> </span><span class="s">}}/config"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>

<span class="w">      </span><span class="c1"># Refresh Lists (updates dropdowns immediately)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="s">"00:00:01"</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.trigger</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.system_populate_notify_services</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">skip_condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="c1"># Reset dropdown to safe default</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.select_option</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_delete_category</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">option</span><span class="p">:</span><span class="w"> </span><span class="s">"-select-"</span>

<span class="w">  </span><span class="c1"># --- ADD NEW CATEGORY (Global + All Users) ---</span>
<span class="w">  </span><span class="nt">add_notify_category_global</span><span class="p">:</span>
<span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">Add</span><span class="nv"> </span><span class="s">Notification</span><span class="nv"> </span><span class="s">Category"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:playlist-plus</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">single</span>
<span class="w">    </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="nt">new_category</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_text.notify_add_category')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">trim</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">lower</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">current_list</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_text.notify_mgmt_categories')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="c1"># 1. Update Master List (if not exists)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">            </span><span class="nt">value_template</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">current_list.split(',')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">        </span><span class="nt">then</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_text.set_value</span>
<span class="w">            </span><span class="nt">target</span><span class="p">:</span>
<span class="w">              </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_text.notify_mgmt_categories</span>
<span class="w">            </span><span class="nt">data</span><span class="p">:</span>
<span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">current_list</span><span class="nv"> </span><span class="s">~</span><span class="nv"> </span><span class="s">','</span><span class="nv"> </span><span class="s">~</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">current_list|length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="c1"># 2. Create Global Setting Switch</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_category_{{</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">}}_local/config"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">              </span><span class="no">"name": "Notify {{ new_category|capitalize }}: When Home",</span>
<span class="w">              </span><span class="no">"default_entity_id": "switch.notify_category_{{ new_category }}_local",</span>
<span class="w">              </span><span class="no">"unique_id": "notify_category_{{ new_category }}_local",</span>
<span class="w">              </span><span class="no">"icon": "mdi:home-account",</span>
<span class="w">              </span><span class="no">"command_topic": "notify/settings/{{ new_category }}/local_only/set",</span>
<span class="w">              </span><span class="no">"state_topic": "notify/settings/{{ new_category }}/local_only/state",</span>
<span class="w">              </span><span class="no">"device": {</span>
<span class="w">                </span><span class="no">"identifiers": ["notify_system_settings"],</span>
<span class="w">                </span><span class="no">"name": "Cat |",</span>
<span class="w">                </span><span class="no">"manufacturer": "Home Assistant",</span>
<span class="w">                </span><span class="no">"model": "Global Rules"</span>
<span class="w">              </span><span class="no">}</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">      </span><span class="c1"># Init to OFF</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/settings/{{</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">}}/local_only/state"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"OFF"</span>

<span class="w">      </span><span class="c1"># 3. Add Switch to ALL Existing Users</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.text </span>
<span class="w">               </span><span class="no">| selectattr('entity_id', 'search', '^text\.notify_service_') </span>
<span class="w">               </span><span class="no">| map(attribute='object_id') </span>
<span class="w">               </span><span class="no">| map('replace', 'notify_service_', '') </span>
<span class="w">               </span><span class="no">| list }}</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">                </span><span class="nt">user_slug</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">            </span><span class="c1"># Create the switch for this user</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">}}/config"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{</span>
<span class="w">                    </span><span class="no">"name": "{{ new_category|capitalize }} Notification",</span>
<span class="w">                    </span><span class="no">"object_id": "{{ new_category }}_notification_{{ user_slug }}",</span>
<span class="w">                    </span><span class="no">"default_entity_id": "switch.{{ new_category }}_notification_{{ user_slug }}",</span>
<span class="w">                    </span><span class="no">"unique_id": "notify_switch_{{ user_slug }}_{{ new_category }}",</span>
<span class="w">                    </span><span class="no">"icon": "mdi:bell-ring",</span>
<span class="w">                    </span><span class="no">"command_topic": "notify/{{ user_slug }}/{{ new_category }}/set",</span>
<span class="w">                    </span><span class="no">"state_topic": "notify/{{ user_slug }}/{{ new_category }}/state",</span>
<span class="w">                    </span><span class="no">"availability_topic": "notify/{{ user_slug }}/availability",</span>
<span class="w">                    </span><span class="no">"payload_available": "online",</span>
<span class="w">                    </span><span class="no">"json_attributes_topic": "notify/{{ user_slug }}/attributes",</span>
<span class="w">                    </span><span class="no">"device": {</span>
<span class="w">                      </span><span class="no">"identifiers": ["notify_user_{{ user_slug }}"],</span>
<span class="w">                      </span><span class="no">"manufacturer": "Home Assistant",</span>
<span class="w">                      </span><span class="no">"model": "Notification Profile"</span>
<span class="w">                    </span><span class="no">}</span>
<span class="w">                  </span><span class="no">}</span>
<span class="w">            </span><span class="c1"># Set State ON</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">}}/state"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"ON"</span>

<span class="w">      </span><span class="c1"># 4. Add Switch to ALL Smart Speakers</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="nt">all_speakers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.switch </span>
<span class="w">               </span><span class="no">| selectattr('attributes.speaker_slug', 'defined')</span>
<span class="w">               </span><span class="no">| map(attribute='attributes.speaker_slug')</span>
<span class="w">               </span><span class="no">| unique</span>
<span class="w">               </span><span class="no">| list }}</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">all_speakers</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/speaker_{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}_notify_{{</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">}}/config"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{{</span>
<span class="w">                    </span><span class="no">{</span>
<span class="w">                      </span><span class="no">"name": new_category | title,</span>
<span class="w">                      </span><span class="no">"default_entity_id": "switch.speaker_" ~ repeat.item ~ "_notify_" ~ new_category,</span>
<span class="w">                      </span><span class="no">"unique_id": "speaker_notif_" ~ repeat.item ~ "_" ~ new_category ~ "_v4",</span>
<span class="w">                      </span><span class="no">"icon": "mdi:bell-ring",</span>
<span class="w">                      </span><span class="no">"command_topic": "speaker/" ~ repeat.item ~ "/notify_" ~ new_category ~ "/set",</span>
<span class="w">                      </span><span class="no">"state_topic": "speaker/" ~ repeat.item ~ "/notify_" ~ new_category ~ "/state",</span>
<span class="w">                      </span><span class="no">"payload_on": "ON",</span>
<span class="w">                      </span><span class="no">"payload_off": "OFF",</span>
<span class="w">                      </span><span class="no">"device": { "identifiers": ["smart_speaker_" ~ repeat.item] }</span>
<span class="w">                    </span><span class="no">} | to_json</span>
<span class="w">                  </span><span class="no">}}</span>
<span class="w">            </span><span class="c1"># Default to ON</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"speaker/{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}/notify_{{</span><span class="nv"> </span><span class="s">new_category</span><span class="nv"> </span><span class="s">}}/state"</span>
<span class="w">                </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"ON"</span>

<span class="w">      </span><span class="c1"># Refresh Lists</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="s">"00:00:01"</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.trigger</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automation.system_populate_notify_services</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">skip_condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="c1"># --- MASTER ROUTER (Unchanged) ---</span>
<span class="w">  </span><span class="nt">notify_smart_master</span><span class="p">:</span>
<span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"Notify:</span><span class="nv"> </span><span class="s">Master</span><span class="nv"> </span><span class="s">Router"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:message-badge-outline</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parallel</span>
<span class="w">    </span><span class="nt">fields</span><span class="p">:</span>
<span class="w">      </span><span class="nt">category</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Notification</span><span class="nv"> </span><span class="s">Category"</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">"info"</span>
<span class="w">      </span><span class="nt">title</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Title"</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Body"</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Image</span><span class="nv"> </span><span class="s">Path"</span>
<span class="w">      </span><span class="nt">tag</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Grouping</span><span class="nv"> </span><span class="s">tag"</span>
<span class="w">      </span><span class="nt">actions</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"List</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">buttons"</span>
<span class="w">      </span><span class="nt">clickAction</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Link</span><span class="nv"> </span><span class="s">click"</span>
<span class="w">      </span><span class="nt">sticky</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Sticky"</span>
<span class="w">      </span><span class="nt">critical</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Critical</span><span class="nv"> </span><span class="s">alert"</span>
<span class="w">      </span><span class="nt">presence_only</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Override:</span><span class="nv"> </span><span class="s">Force</span><span class="nv"> </span><span class="s">check</span><span class="nv"> </span><span class="s">presence"</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">      </span><span class="nt">source_room</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Slug</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">room</span><span class="nv"> </span><span class="s">where</span><span class="nv"> </span><span class="s">event</span><span class="nv"> </span><span class="s">originated</span><span class="nv"> </span><span class="s">(for</span><span class="nv"> </span><span class="s">suppression)"</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">      </span><span class="nt">room</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Override:</span><span class="nv"> </span><span class="s">Specific</span><span class="nv"> </span><span class="s">room</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">target</span><span class="nv"> </span><span class="s">(bypass</span><span class="nv"> </span><span class="s">occupancy)"</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">    </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="nt">global_presence_setting</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states('switch.notify_category_' ~ category | default('info') ~ '_local') == 'on' }}</span>
<span class="w">          </span><span class="nt">use_presence_check</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{% set pres = presence_only | default(none) %}</span>
<span class="w">            </span><span class="no">{{ pres if pres is not none else global_presence_setting }}</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.switch </span>
<span class="w">               </span><span class="no">| selectattr('entity_id', 'search', '\.' ~ category | default('info') ~ '_notification_')</span>
<span class="w">               </span><span class="no">| selectattr('state', 'eq', 'on')</span>
<span class="w">               </span><span class="no">| map(attribute='entity_id')</span>
<span class="w">               </span><span class="no">| list }}</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">                </span><span class="nt">match_id</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="c1"># Fallback: Extract from Entity ID</span>
<span class="w">                </span><span class="nt">slug_from_id</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{{ repeat.item </span>
<span class="w">                     </span><span class="no">| replace('switch.', '') </span>
<span class="w">                     </span><span class="no">| replace(category | default('info') ~ '_notify_', '') </span>
<span class="w">                     </span><span class="no">| replace('_notification', '') }}</span>
<span class="w">                </span><span class="nt">user_slug</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">state_attr(repeat.item,</span><span class="nv"> </span><span class="s">'user_slug')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(slug_from_id,</span><span class="nv"> </span><span class="s">true)</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="c1"># Fetch Service</span>
<span class="w">                </span><span class="nt">target_service</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('text.notify_service_'</span><span class="nv"> </span><span class="s">~</span><span class="nv"> </span><span class="s">user_slug)</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="c1"># Fetch Linked Person for Presence Check</span>
<span class="w">                </span><span class="nt">linked_person</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">state_attr(repeat.item,</span><span class="nv"> </span><span class="s">'linked_person')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system_log.write</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">"DEBUG</span><span class="nv"> </span><span class="s">MOBILE</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">user_slug</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">Service:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">target_service</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">Match:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">match_id</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">                  </span><span class="nt">value_template</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                    </span><span class="no">{{ </span>
<span class="w">                      </span><span class="no">target_service is not none and target_service not in ['unknown', 'unavailable', '']</span>
<span class="w">                      </span><span class="no">and (</span>
<span class="w">                        </span><span class="no">use_presence_check == false </span>
<span class="w">                        </span><span class="no">or (linked_person is not none and is_state(linked_person, 'home'))</span>
<span class="w">                      </span><span class="no">)</span>
<span class="w">                    </span><span class="no">}}</span>
<span class="w">              </span><span class="nt">then</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">target_service</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                  </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">title</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('Notification')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">message</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                    </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">tag</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                      </span><span class="nt">sticky</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">sticky</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(false)</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                      </span><span class="nt">push</span><span class="p">:</span>
<span class="w">                        </span><span class="nt">sound</span><span class="p">:</span>
<span class="w">                          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"default"</span>
<span class="w">                          </span><span class="nt">critical</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">critical</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(false)</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                          </span><span class="nt">volume</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">1.0</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">critical</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(false)</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">0.5</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                      </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">critical</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(false)</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                      </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">'high'</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">critical</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(false)</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">'normal'</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                      </span><span class="nt">clickAction</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                        </span><span class="no">{% set clk = clickAction | default('') %}</span>
<span class="w">                        </span><span class="no">{% if target_platform == 'ios' and 'app://' in (clk|string) %}</span>
<span class="w">                          </span><span class="no">unifi-protect://</span>
<span class="w">                        </span><span class="no">{% else %}</span>
<span class="w">                          </span><span class="no">{{ clk }}</span>
<span class="w">                        </span><span class="no">{% endif %}</span>
<span class="w">                      </span><span class="nt">actions</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">actions</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default([])</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">      </span><span class="c1"># --- 2. SMART SPEAKER ROUTING ---</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># Define Priority based on Critical flag or Category</span>
<span class="w">          </span><span class="c1"># Categories 'alarm', 'security', 'doorbell', 'smoke' are inherently Critical</span>
<span class="w">          </span><span class="nt">is_critical</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ critical | default(false) or category in ['alarm', 'security', 'doorbell', 'smoke'] }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># Find all speakers subscribed to this category</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.switch </span>
<span class="w">               </span><span class="no">| selectattr('entity_id', 'search', '^switch\.speaker_.*_notify_' ~ category | default('info'))</span>
<span class="w">               </span><span class="no">| selectattr('state', 'eq', 'on')</span>
<span class="w">               </span><span class="no">| map(attribute='entity_id')</span>
<span class="w">               </span><span class="no">| list }}</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">                </span><span class="c1"># Extract Slug: switch.speaker_{slug}_notify_{category}</span>
<span class="w">                </span><span class="nt">config_entity</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="c1"># Regex to pull slug</span>
<span class="w">                </span><span class="nt">speaker_slug</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{{ config_entity </span>
<span class="w">                     </span><span class="no">| replace('switch.speaker_', '') </span>
<span class="w">                     </span><span class="no">| replace('_notify_' ~ category | default('info'), '') }}</span>

<span class="w">                </span><span class="c1"># Get Config Entity (now attached to Quiet Mode Switch)</span>
<span class="w">                </span><span class="nt">speaker_config_entity</span><span class="p">:</span><span class="w"> </span><span class="s">"switch.speaker_{{</span><span class="nv"> </span><span class="s">speaker_slug</span><span class="nv"> </span><span class="s">}}_quiet_mode"</span>

<span class="w">                </span><span class="c1"># Attributes are on the switch now</span>
<span class="w">                </span><span class="c1"># Attributes are on the switch now</span>
<span class="w">                </span><span class="nt">media_player</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">state_attr(speaker_config_entity,</span><span class="nv"> </span><span class="s">'entity_id')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="c1"># Get Linked Areas</span>
<span class="w">                </span><span class="nt">linked_areas</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">state_attr(media_player,</span><span class="nv"> </span><span class="s">'linked_areas')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default([])</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">                </span><span class="c1"># Status Tests</span>
<span class="w">                </span><span class="nt">dnd_switch</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">speaker_config_entity</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="c1"># Check if Quiet Mode is ON</span>
<span class="w">                </span><span class="nt">is_dnd_active</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">is_state(dnd_switch,</span><span class="nv"> </span><span class="s">'on')</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">                </span><span class="c1"># Room State Checks (Sleep/DND)</span>
<span class="w">                </span><span class="c1"># We check if ANY linked room is in a restrictive state</span>
<span class="w">                </span><span class="nt">is_room_quiet</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{% set ns = namespace(quiet=false) %}</span>
<span class="w">                  </span><span class="no">{% for area in linked_areas %}</span>
<span class="w">                    </span><span class="no">{% set state = states('select.area_' ~ area ~ '_state') %}</span>
<span class="w">                    </span><span class="no">{% if state in ['Sleep', 'DND'] %}</span>
<span class="w">                      </span><span class="no">{% set ns.quiet = true %}</span>
<span class="w">                    </span><span class="no">{% endif %}</span>
<span class="w">                  </span><span class="no">{% endfor %}</span>
<span class="w">                  </span><span class="no">{{ ns.quiet }}</span>

<span class="w">                </span><span class="c1"># Occupancy Check</span>
<span class="w">                </span><span class="nt">is_occupied</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{% set ns = namespace(occupied=false) %}</span>
<span class="w">                  </span><span class="no">{% set areas = linked_areas if linked_areas is iterable and linked_areas is not string else [] %}</span>
<span class="w">                  </span><span class="no">{% for area in areas %}</span>
<span class="w">                    </span><span class="no">{# Debug Sensor Logic #}</span>
<span class="w">                    </span><span class="no">{% set s1 = 'binary_sensor.area_' ~ area ~ '_occupancy' %}</span>
<span class="w">                    </span><span class="no">{% set s2 = 'binary_sensor.' ~ area ~ '_occupancy' %}</span>
<span class="w">                    </span><span class="no">{% set v1 = states(s1) %}</span>
<span class="w">                    </span><span class="no">{% set v2 = states(s2) %}</span>

<span class="w">                    </span><span class="no">{# Logic #}</span>
<span class="w">                    </span><span class="no">{% if v1 == 'on' or v2 == 'on' %}</span>
<span class="w">                      </span><span class="no">{% set ns.occupied = true %}</span>
<span class="w">                    </span><span class="no">{% endif %}</span>
<span class="w">                  </span><span class="no">{% endfor %}</span>
<span class="w">                  </span><span class="no">{{ ns.occupied }}</span>

<span class="w">                </span><span class="c1"># Extended Debug Info</span>
<span class="w">                </span><span class="nt">debug_occ_trace</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{% set areas = linked_areas if linked_areas is iterable and linked_areas is not string else [] %}</span>
<span class="w">                  </span><span class="no">{% set ns = namespace(log=[]) %}</span>
<span class="w">                  </span><span class="no">{% for area in areas %}</span>
<span class="w">                     </span><span class="no">{% set s1 = 'binary_sensor.area_' ~ area ~ '_occupancy' %}</span>
<span class="w">                     </span><span class="no">{% set s2 = 'binary_sensor.' ~ area ~ '_occupancy' %}</span>
<span class="w">                     </span><span class="no">{% set ns.log = ns.log + [s1 ~ '=' ~ states(s1) ~ ' / ' ~ s2 ~ '=' ~ states(s2)] %}</span>
<span class="w">                  </span><span class="no">{% endfor %}</span>
<span class="w">                  </span><span class="no">{{ ns.log | join(', ') }}</span>

<span class="w">                </span><span class="c1"># Source Suppression Check</span>
<span class="w">                </span><span class="c1"># If source_room is provided, and matches a linked room, and I am in that room?</span>
<span class="w">                </span><span class="c1"># Design: "If source_room is Occupied, start simple: If source matches linked room, suppress"</span>
<span class="w">                </span><span class="c1"># Actually User said: "coffee ready... you in kitchen... silence"</span>
<span class="w">                </span><span class="c1"># So: If source_room is in linked_rooms AND binary_sensor.room_{source_room}_occupancy is ON -&gt; Suppress</span>
<span class="w">                </span><span class="nt">is_at_source</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{% if source_room is defined and source_room and source_room in linked_areas and is_state('binary_sensor.area_' ~ source_room ~ '_occupancy', 'on') %}</span>
<span class="w">                    </span><span class="no">true</span>
<span class="w">                  </span><span class="no">{% else %}</span>
<span class="w">                    </span><span class="no">false</span>
<span class="w">                  </span><span class="no">{% endif %}</span>

<span class="w">                </span><span class="c1"># Targeted Override: If 'room' var is passed, force speak in that room (bypass occupancy)</span>
<span class="w">                </span><span class="c1"># Targeted Override: Check if my linked rooms match the requested targets</span>
<span class="w">                </span><span class="nt">is_targeted</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">{% if room is defined and room not in [none, '', 'unknown'] %}</span>
<span class="w">                     </span><span class="no">{% set targets = (room | string).split(',') | map('trim') | list %}</span>
<span class="w">                     </span><span class="no">{% set ns = namespace(match=false) %}</span>
<span class="w">                     </span><span class="no">{% for r in linked_areas %}</span>
<span class="w">                       </span><span class="no">{% if r in targets %}</span>
<span class="w">                         </span><span class="no">{% set ns.match = true %}</span>
<span class="w">                       </span><span class="no">{% endif %}</span>
<span class="w">                     </span><span class="no">{% endfor %}</span>
<span class="w">                     </span><span class="no">{{ ns.match }}</span>
<span class="w">                  </span><span class="no">{% else %}</span>
<span class="w">                     </span><span class="no">false</span>
<span class="w">                  </span><span class="no">{% endif %}</span>

<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system_log.write</span>
<span class="w">              </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                  </span><span class="no">DEBUG SPEAKER {{ speaker_slug }} | </span>
<span class="w">                  </span><span class="no">Media: {{ media_player }} | </span>
<span class="w">                  </span><span class="no">Targeted: {{ is_targeted }} | </span>
<span class="w">                  </span><span class="no">Room: {{ room }} |</span>
<span class="w">                  </span><span class="no">Linked: {{ linked_rooms }} |</span>
<span class="w">                  </span><span class="no">Occ: {{ is_occupied }} | </span>
<span class="w">                  </span><span class="no">DND: {{ is_dnd_active }} | </span>
<span class="w">                  </span><span class="no">Quiet: {{ is_room_quiet }}</span>
<span class="w">                </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>

<span class="w">            </span><span class="c1"># LOGIC GATE</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">                  </span><span class="nt">value_template</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">                    </span><span class="no">{% set source_bool = is_at_source | bool %}</span>
<span class="w">                    </span><span class="no">{% set allow_priority = is_critical or (not is_dnd_active and not is_room_quiet) %}</span>

<span class="w">                    </span><span class="no">{# Logic Gate: Exclusive Targeting vs Occupancy #}</span>
<span class="w">                    </span><span class="no">{% set global_target_defined = room is defined and room not in [none, '', 'unknown'] %}</span>

<span class="w">                    </span><span class="no">{% if global_target_defined %}</span>
<span class="w">                       </span><span class="no">{# If targeting is active, ONLY allow targeted speakers #}</span>
<span class="w">                       </span><span class="no">{% set allow_occupancy = is_targeted %}</span>
<span class="w">                    </span><span class="no">{% else %}</span>
<span class="w">                       </span><span class="no">{# Standard Mode: Play if Critical OR Occupied #}</span>
<span class="w">                       </span><span class="no">{% set allow_occupancy = is_critical or is_occupied %}</span>
<span class="w">                    </span><span class="no">{% endif %}</span>

<span class="w">                    </span><span class="no">{% set allow_source = not source_bool %}</span>
<span class="w">                    </span><span class="no">{{ allow_priority and allow_occupancy and allow_source }}</span>
<span class="w">              </span><span class="nt">then</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system_log.write</span>
<span class="w">                  </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">"DEBUG:</span><span class="nv"> </span><span class="s">Speaking</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">media_player</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">(Method:</span><span class="nv"> </span><span class="s">Cloud</span><span class="nv"> </span><span class="s">Say).</span><span class="nv"> </span><span class="s">Msg:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">message</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tts.cloud_say</span>
<span class="w">                  </span><span class="nt">target</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">media_player</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                  </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">message</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                    </span><span class="c1"># Optionally add chimes for critical?</span>
<span class="w">                    </span><span class="nt">options</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">voice</span><span class="p">:</span><span class="w"> </span><span class="s">"Katherine"</span><span class="w"> </span><span class="c1"># Customize as needed</span>

<span class="w">  </span><span class="c1"># --- DEBUG DIAGNOSTICS ---</span>
<span class="w">  </span><span class="nt">debug_notify_diagnostics</span><span class="p">:</span>
<span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">Debug</span><span class="nv"> </span><span class="s">Notification</span><span class="nv"> </span><span class="s">Targets"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:bug</span>
<span class="w">    </span><span class="nt">fields</span><span class="p">:</span>
<span class="w">      </span><span class="nt">category</span><span class="p">:</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Category</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">test"</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">"info"</span>
<span class="w">    </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="nt">cat</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">category</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('info')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="c1"># 1. Dump ALL Switches that look related</span>
<span class="w">          </span><span class="nt">all_switches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.switch | map(attribute='entity_id') | select('search', 'notify|speaker') | list }}</span>

<span class="w">          </span><span class="c1"># 2. Test Mobile Regex</span>
<span class="w">          </span><span class="nt">mobile_regex</span><span class="p">:</span><span class="w"> </span><span class="s">"_{{</span><span class="nv"> </span><span class="s">cat</span><span class="nv"> </span><span class="s">}}_notification"</span>
<span class="w">          </span><span class="nt">mobile_matches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.switch </span>
<span class="w">               </span><span class="no">| selectattr('entity_id', 'search', mobile_regex)</span>
<span class="w">               </span><span class="no">| map(attribute='entity_id') | list }}</span>

<span class="w">          </span><span class="c1"># 3. Test Speaker Regex</span>
<span class="w">          </span><span class="nt">speaker_regex</span><span class="p">:</span><span class="w"> </span><span class="s">"^switch\\.speaker_.*_notify_{{</span><span class="nv"> </span><span class="s">cat</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">speaker_matches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.switch </span>
<span class="w">               </span><span class="no">| selectattr('entity_id', 'search', speaker_regex)</span>
<span class="w">               </span><span class="no">| map(attribute='entity_id') | list }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system_log.write</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">          </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">DEBUG DIAGNOSTICS (Category: {{ cat }})</span>
<span class="w">            </span><span class="no">--------------------------------------------------</span>
<span class="w">            </span><span class="no">Regex Mobile: '{{ mobile_regex }}' -&gt; Found: {{ mobile_matches }}</span>
<span class="w">            </span><span class="no">Regex Speaker: '{{ speaker_regex }}' -&gt; Found: {{ speaker_matches }}</span>
<span class="w">            </span><span class="no">--------------------------------------------------</span>
<span class="w">            </span><span class="no">ALL CANDIDATES: {{ all_switches }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system_log.write</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">          </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">DEBUG DIAGNOSTICS (Category: {{ cat }})</span>
<span class="w">            </span><span class="no">--------------------------------------------------</span>
<span class="w">            </span><span class="no">Regex Mobile: '{{ mobile_regex }}' -&gt; Found: {{ mobile_matches }}</span>
<span class="w">            </span><span class="no">Regex Speaker: '{{ speaker_regex }}' -&gt; Found: {{ speaker_matches }}</span>
<span class="w">            </span><span class="no">--------------------------------------------------</span>
<span class="w">            </span><span class="no">ALL CANDIDATES: {{ all_switches }}</span>

<span class="w">  </span><span class="c1"># --- PURGE GHOSTS ---</span>
<span class="w">  </span><span class="nt">purge_notification_ghosts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">Purge</span><span class="nv"> </span><span class="s">Legacy</span><span class="nv"> </span><span class="s">Notification</span><span class="nv"> </span><span class="s">Ghosts"</span>
<span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:ghost-off</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">single</span>
<span class="w">    </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">          </span><span class="nt">categories</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">states('input_text.notify_mgmt_categories').split(',')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">map('trim')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">['action',</span><span class="nv"> </span><span class="s">'doorbell',</span><span class="nv"> </span><span class="s">'doorbell2',</span><span class="nv"> </span><span class="s">'network']</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">users</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">            </span><span class="no">{{ states.text </span>
<span class="w">               </span><span class="no">| selectattr('entity_id', 'search', '^text\.notify_service_') </span>
<span class="w">               </span><span class="no">| map(attribute='object_id') </span>
<span class="w">               </span><span class="no">| map('replace', 'notify_service_', '') </span>
<span class="w">               </span><span class="no">| list }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">          </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">users</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">                </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repeat</span><span class="p">:</span>
<span class="w">                </span><span class="nt">for_each</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">categories</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">                </span><span class="nt">sequence</span><span class="p">:</span>
<span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">cat</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">repeat.item</span><span class="nv"> </span><span class="s">}}"</span>

<span class="w">                  </span><span class="c1"># PATTERN 1: switch.Evis_garden_notification</span>
<span class="w">                  </span><span class="c1"># Topic: homeassistant/switch/Evis_garden_notification/config (Guess)</span>
<span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">                    </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                      </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/{{</span><span class="nv"> </span><span class="s">user</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">cat</span><span class="nv"> </span><span class="s">}}_notification/config"</span>
<span class="w">                      </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>

<span class="w">                  </span><span class="c1"># PATTERN 2: switch.Evis_garden_notify</span>
<span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">                    </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                      </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/{{</span><span class="nv"> </span><span class="s">user</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">cat</span><span class="nv"> </span><span class="s">}}_notify/config"</span>
<span class="w">                      </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>

<span class="w">                  </span><span class="c1"># PATTERN 3: switch.notify_garden_Evis (Old Flipped)</span>
<span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">                    </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                      </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_{{</span><span class="nv"> </span><span class="s">cat</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">user</span><span class="nv"> </span><span class="s">}}/config"</span>
<span class="w">                      </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span>

<span class="w">                  </span><span class="c1"># PATTERN 4: switch.notify_Evis_garden (Legacy Loop)</span>
<span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">                    </span><span class="nt">data</span><span class="p">:</span>
<span class="w">                      </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                      </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"homeassistant/switch/notify_{{</span><span class="nv"> </span><span class="s">user</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">cat</span><span class="nv"> </span><span class="s">}}/config"</span>
<span class="w">                      </span><span class="c1"># Wait! Pattern 4 IS THE CURRENT CORRECT TOPIC.</span>
<span class="w">                      </span><span class="c1"># DO NOT DELETE THIS unless object_id matches bad pattern?</span>
<span class="w">                      </span><span class="c1"># We cannot target object_id here, only topic.</span>
<span class="w">                      </span><span class="c1"># IF the ghost shares the topic with the new entity, deleting it kills the new entity too.</span>
<span class="w">                      </span><span class="c1"># BUT create_notify_user will restore it.</span>
<span class="w">                      </span><span class="c1"># Safer to NOT touch Pattern 4.</span>
<span class="w">                      </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># SKIP THIS ONE</span>

<span class="nt">automation</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">Populate</span><span class="nv"> </span><span class="s">Notify</span><span class="nv"> </span><span class="s">Services"</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">populate_notify_services_auto</span>
<span class="w">    </span><span class="nt">trigger</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeassistant</span>
<span class="w">        </span><span class="nt">event</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">start</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time_pattern</span>
<span class="w">        </span><span class="nt">hours</span><span class="p">:</span><span class="w"> </span><span class="s">"/1"</span>
<span class="w">    </span><span class="nt">action</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Use this to populate the new person selector list</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.set_options</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_mgmt_person_select</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">            </span><span class="no">{% set person_names = states.person | map(attribute='attributes.friendly_name') | list | sort %}</span>
<span class="w">            </span><span class="no">{{ ['-select-'] + person_names + ['Guest'] }} # Always include 'Guest' option</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.set_options</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_mgmt_service</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">            </span><span class="no">{% set ns = namespace(services=[]) %}</span>
<span class="w">            </span><span class="no">{% set trackers = integration_entities('mobile_app') | select('search', '^device_tracker\.') | list %}</span>
<span class="w">            </span><span class="no">{% for tracker in trackers %}</span>
<span class="w">              </span><span class="no">{% set dev_id = device_id(tracker) %}</span>
<span class="w">              </span><span class="no">{% set dev_name = device_attr(dev_id, 'name') %}</span>
<span class="w">              </span><span class="no">{% if dev_name %}</span>
<span class="w">                </span><span class="no">{% set service_name = 'notify.mobile_app_' ~ dev_name | slugify %}</span>
<span class="w">                </span><span class="no">{% set ns.services = ns.services + [service_name] %}</span>
<span class="w">              </span><span class="no">{% endif %}</span>
<span class="w">            </span><span class="no">{% endfor %}</span>
<span class="w">            </span><span class="no">{{ (['-select-'] + ns.services + ['notify.mobile_app_unknown']) | unique | sort }}</span>

<span class="w">      </span><span class="c1"># 3. Populate Delete User list</span>
<span class="w">      </span><span class="c1"># Scans for existing 'text.notify_service_*' entities to find valid user slugs</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.set_options</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_mgmt_delete_user_select</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">            </span><span class="no">{% set ns = namespace(users=[]) %}</span>
<span class="w">            </span><span class="no">{% set user_helpers = states.text | selectattr('object_id', 'search', '^notify_service_') | list %}</span>
<span class="w">            </span><span class="no">{% for helper in user_helpers %}</span>
<span class="w">               </span><span class="no">{% set slug = helper.object_id.replace('notify_service_', '') %}</span>
<span class="w">               </span><span class="no">{% set ns.users = ns.users + [slug] %}</span>
<span class="w">            </span><span class="no">{% endfor %}</span>
<span class="w">            </span><span class="no">{{ (['-select-'] + ns.users + ['unknown']) | unique | sort }}</span>

<span class="w">      </span><span class="c1"># 4. Populate Delete Category List (NEW)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.set_options</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span>
<span class="w">          </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_select.notify_delete_category</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">            </span><span class="no">{% set cats = states('input_text.notify_mgmt_categories').split(',') </span>
<span class="w">               </span><span class="no">| map('trim') </span>
<span class="w">               </span><span class="no">| select('ne', '')</span>
<span class="w">               </span><span class="no">| list </span>
<span class="w">               </span><span class="no">| sort %}</span>
<span class="w">            </span><span class="no">{{ ['-select-'] + cats }}</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s">"System:</span><span class="nv"> </span><span class="s">MQTT</span><span class="nv"> </span><span class="s">State</span><span class="nv"> </span><span class="s">Persistence"</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system_mqtt_state_persistence</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">parallel</span>
<span class="w">    </span><span class="nt">trigger</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt</span>
<span class="w">        </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"notify/#"</span>
<span class="w">    </span><span class="nt">condition</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">        </span><span class="nt">value_template</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">trigger.topic.endswith('/set')</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">    </span><span class="nt">action</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mqtt.publish</span>
<span class="w">        </span><span class="nt">data</span><span class="p">:</span>
<span class="w">          </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">trigger.topic[:-4]</span><span class="nv"> </span><span class="s">}}/state"</span>
<span class="w">          </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">trigger.payload</span><span class="nv"> </span><span class="s">}}"</span>
<span class="w">          </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  2026 EvisHome
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            


  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better. We use Google Analytics to collect anonymous usage data.</p>
<input class="md-toggle" type="checkbox" id="__settings">
<div class="md-consent__settings">
  <ul class="task-list">
    
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics">
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.indexes"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>