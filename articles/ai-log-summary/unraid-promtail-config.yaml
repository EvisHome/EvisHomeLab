# File: /mnt/docker/appdata/promtail/config.yaml

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /etc/promtail/positions.yaml

clients:
  - url: http://127.0.0.1:3100/loki/api/v1/push

scrape_configs:
  # -----------------------------------------------------------
  # 1. LOCAL DOCKER (Unraid) -> job="docker"
  # -----------------------------------------------------------
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ["__meta_docker_container_name"]
        regex: "/(.*)"
        target_label: "container_name"
      - target_label: "host"
        replacement: "unraid"
    pipeline_stages:
      - docker: {}
      - drop:
          older_than: 24h
          drop_counter_reason: "too_old"

  # -----------------------------------------------------------
  # 2. LOCAL SYSLOG (Unraid OS) -> job="syslog"
  # -----------------------------------------------------------
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          host: unraid
          __path__: /var/log/syslog
    pipeline_stages:
      - drop:
          older_than: 24h

  # -----------------------------------------------------------
  # 3. NETWORK SYSLOG (UniFi & Proxmox) -> job="unifi" / "proxmox"
  # -----------------------------------------------------------

  # --- UniFi Listener (CEF Format via Unraid Syslog Server) ---
  - job_name: unifi
    static_configs:
      - targets:
          - localhost
        labels:
          job: unifi
          __path__: /mnt/user/appdata/syslog-*.log
    pipeline_stages:
      # 1. Extract the IP from the filename (e.g., syslog-10.0.0.1.log)
      - regex:
          source: filename
          expression: ".*syslog-(?P<device_ip>.*)\\.log"

      # 2. Parse the CEF line you provided
      - regex:
          # This updated regex handles the double timestamp/hostname prefix
          expression: "^(?P<ts>\\w{3}\\s+\\d+\\s\\d+:\\d+:\\d+).+CEF:(?P<cef_ver>\\d+)\\|(?P<vendor>[^|]+)\\|(?P<product>[^|]+)\\|(?P<version>[^|]+)\\|(?P<category>[^|]+)\\|(?P<severity>[^|]+)\\|(?P<extension>.*)"

      # 3. Use logfmt to parse the 'extension' into individual labels
      - logfmt:
          source: extension
          mapping:
            msg: msg
            eventType: eventType
            UNIFIcategory: UNIFIcategory

      # 4. Apply the extracted data as Labels
      - labels:
          device_ip: device_ip
          product: product
          category: category
          severity: severity
          eventType: eventType # Extracted by logfmt
          UNIFIcategory: UNIFIcategory
          msg: msg # Extracted by logfmt

      # 5. Use the actual timestamp from the log line
      - timestamp:
          source: ts
          format: "Jan _2 15:04:05"
          # --- ADD THIS LINE ---
          location: "Europe/Helsinki"
          # Optional: If parsing fails, use the current time instead of erroring
          action_on_failure: skip

  # --- Proxmox Listener (RFC5424 / IETF Format) ---
  - job_name: syslog-proxmox
    syslog:
      listen_address: 0.0.0.0:1514
      listen_protocol: udp
      idle_timeout: 60s
      label_structured_data: yes
      labels:
        job: proxmox
    relabel_configs:
      - source_labels: ["__syslog_message_hostname"]
        target_label: "host"
